#ifndef _GENERATE_H
#define _GENERATE_H

#include <iostream>
#include <string>
#include <vector>
#include <stdio.h>
#include <thread>
#include <math.h>
#include <regex>
#include <mutex>
#include <shared_mutex>
#include "core_cpu.h"
#include "entities.h"
#include "pool.h"
#include "liteqwen.h"

namespace liteqwen {
    void UploadInputs(int gpu_id, bool is_prefill, const Data& input_ids, const Data& inp_batch_ids, const Data& query_pos_starts, const Data& key_pos_starts, int* cpu_input_ids, uint8_t* cpu_inp_bids, int* cpu_query_starts, int prefill_len, int bsz);

    void forward(Data* logits_ptr, bool is_prefill, StringArray request_ids, int* cpu_inp_ids, int* cpu_query_starts, const Data& input_ids, const Data& inp_batch_ids, const Data& key_pos_starts, const Data& val_pos_starts, int batch_maxlen, int dynamic_bl, const LoraConfig& lora_cfg, Qwen2Params* config_ref, const Data& cos_embed, const Data& sim_embed, std::map<std::string, Data>* weights, std::map<std::string, std::pair<int, uintptr_t>>* quant4_meta, PipelineKVPool* kv_cache_ref, ExecuteTimer* timer);

    LoraConfig GetLora(std::string preparer_name, std::string one_req_lora, std::map<std::string, liteqwen::LoraConfig>* lora_meta);
    void Generate(int data_id, std::shared_ptr<ContextPool> pool, Qwen2Params model_param, std::map<std::string, Data*>* cpu_weights_ptr, std::map<std::string, 
    
    liteqwen::LoraConfig>* lora_meta, std::map<std::string, liteqwen::Q4LinearMeta>* quant_meta);
}

const std::vector<int> warmup_ids{151644,8948,198,2610,525,264,10950,17847,151645,198,151644,872,198,58695,105126,29437,102472,99481,100679,103984,111161,102270,99903,3837,34204,14777,99609,110959,7948,101301,9754,101526,105311,40820,101301,8903,105081,100734,1773,114754,9370,100679,101122,102836,99566,100993,17340,5373,99383,99622,100679,101122,102836,14777,101301,17340,1773,58695,105126,100679,103984,101242,85361,28404,100510,3837,107577,100027,103954,82847,5373,111101,5373,100339,60726,99376,5373,100348,99718,5373,104941,67364,99355,102399,34187,99903,1773,85361,28404,100510,101309,101405,34187,103969,99903,90395,106972,109425,66898,77,1699,262,73562,35987,36993,24562,3837,100056,101467,100679,110185,3837,17714,35987,36993,106972,100418,101077,66898,77,1699,262,34369,101,36993,103930,3837,107793,100679,18493,40820,15946,35987,36993,99919,104066,102442,102088,3837,100342,101121,104197,100176,9370,100125,99358,99463,111809,91956,63703,17340,99663,97907,101060,101079,99461,102384,104629,60548,3837,35987,99210,104360,99164,99887,99730,45181,14777,99609,99612,113297,114278,104407,104437,99403,105442,1773,35987,36993,104075,34187,99876,102166,33108,103044,99257,3837,100140,118787,9370,102330,100138,20412,105045,3837,105651,1773,35987,36993,104075,34187,100710,112949,86119,33108,14777,99609,99612,99609,5373,14777,99609,99568,136277,100845,110996,101039,9370,103956,90395,114076,67338,34187,105004,26898,1773,35987,36993,104998,33108,105826,105881,114253,99774,99358,101088,86119,33108,101883,99335,99728,103947,17404,38182,110564,86119,1773,100012,104117,104407,104437,99403,9370,85106,3837,35987,36993,103930,18493,100497,99424,33108,99599,101091,102438,101046,101367,3837,100692,100497,100383,104844,3837,101046,118469,100008,33108,100680,100679,105725,101071,103984,1773,35987,36993,49185,30767,100348,99718,101309,17714,100679,101091,89977,101122,5373,101091,89977,109294,101122,5373,100679,103984,107577,24968,49185,30767,102473,101598,71304,5373,100693,100317,101285,5373,99445,99974,44991,101309,17714,100679,101091,89977,101122,1773,35987,36993,106350,105122,99796,100342,109597,99919,100497,99424,99912,100682,33108,100004,100497,104360,110787,85106,3837,103930,103975,104875,101082,3837,49185,99622,99789,99316,100269,5373,73038,48888,100572,5373,100693,101384,75405,5373,99347,102671,103309,5373,99445,48888,29258,5373,99789,79599,99467,5373,100348,87256,44793,5373,101129,99225,5373,40542,99839,99609,101309,17714,100679,101122,3837,105314,28072,14880,100497,29437,101301,32571,109597,32664,100147,49185,99622,102485,104744,99626,28951,1773,35987,36993,106265,100348,99718,101309,17714,100679,105725,101071,103984,117432,3837,102473,101598,71304,101309,17714,99802,99703,3837,100693,100317,101285,101309,17714,99749,99703,3837,99789,99316,100269,101309,17714,109294,99703,3837,99445,105501,100523,49567,101309,17714,103028,90395,106265,34187,100679,105725,101071,103984,9370,109294,101122,33108,101122,66898,77,1699,262,34369,101,36993,100140,3837,103969,99903,33108,99903,103982,9370,100679,110185,96050,100497,105881,100629,29258,99750,100240,1773,18493,100369,99903,9370,101908,101925,3837,99466,18493,99313,31118,100091,5373,107033,100383,104558,3837,118765,3837,100305,31838,101188,77144,3837,100418,102005,33108,109552,34187,110539,101367,33108,100497,117980,5373,101060,104844,5373,105158,33108,104049,105158,9370,105615,101503,3837,107987,104893,1773,99903,100690,104415,107033,101309,31838,110158,9370,2073,105320,101096,105320,101367,3837,105320,105725,105320,101972,3837,105320,103967,106846,5373,105320,99605,104753,100285,100305,5373,106267,109739,3837,104323,101053,101091,101689,55807,35987,36993,103930,3837,103962,99360,100137,113465,102026,26939,35987,99210,35987,99292,33108,100342,99200,70769,99532,15946,85336,66898,77,1699,310,42344,14777,7552,59,77,1699,262,34369,101,36993,100002,100679,18493,40820,15946,35987,36993,99919,94498,99943,104066,51463,100545,1773,100342,100125,99358,99463,111809,91956,63703,17340,99663,97907,101091,26288,104073,104847,107792,104629,24968,110996,104513,100642,9370,102005,106344,24968,100342,104423,113707,104893,106492,101689,24968,101055,103044,100138,104513,101088,102442,1773,55338,108802,3837,71268,17714,35987,99210,99360,99257,99164,99887,114278,104407,104437,99403,105442,101077,34187,100844,76095,66898,77,1699,262,34369,101,36993,103988,3837,101055,18493,99185,99876,94443,100294,103967,99191,43268,5373,99185,40916,114774,9370,106098,100145,99522,3837,104847,100676,99335,102174,1773,101055,107672,88308,31843,32664,106449,5373,107070,107773,5373,58463,99295,72225,99818,5373,116388,5373,107306,5373,112964,5373,99685,103001,99079,5373,108919,5373,104600,20929,72225,5373,101059,5373,105906,5373,109123,5373,105394,33108,104320,5373,106055,5373,115153,109700,5373,104123,102322,99599,9370,104925,3837,15946,8903,104939,106098,114305,9370,119205,36885,3837,107545,106417,100145,100416,32108,105877,9370,60548,3837,17714,104320,33108,99489,104939,109150,101088,102007,1773,100131,104304,104264,104187,101120,47606,3837,114120,101046,103140,3837,102422,101077,52726,55806,101919,99885,104481,114979,28946,1773,35987,36993,100140,3837,101067,107545,100145,100416,32108,3837,101055,112704,116275,104109,102112,105623,117626,5373,101884,54658,100919,40952,9370,102653,3837,99461,100642,111391,103952,104162,1773,35987,36993,100437,104109,111582,5373,103337,111582,5373,101947,102908,100804,3837,108612,103106,101949,104725,3837,100656,17714,105623,103967,33108,105623,99403,9370,100701,100640,104279,99666,102007,66898,77,1699,262,6567,107,249,100251,67364,101309,105985,110555,105225,3837,100654,18493,104407,101985,99797,60548,103934,3837,80158,87256,44991,102857,35987,99210,3837,105873,99257,99488,46670,26939,99346,99522,108800,104073,99522,36407,1773,107033,101309,33108,117290,101309,99728,97639,99210,18493,71817,104407,104437,99403,100701,99522,3837,104209,100722,99257,3837,104847,29258,99750,102174,3837,100131,103957,99250,99463,111809,91956,63703,17340,99663,854,115458,34187,3837,104720,34187,1773,104043,3837,101887,97639,100002,104407,99403,104250,100034,3837,99257,101086,17447,99726,105593,105910,33108,32100,3837,74763,115871,34187,100497,99257,99488,102324,9370,60548,1773,99601,3837,100342,104589,100125,99358,99463,111809,91956,63703,17340,99663,97907,101060,101079,99461,102384,104629,60548,3837,103925,102800,100361,33108,99667,9370,101079,99792,105983,3837,106750,104986,36407,109858,71817,3837,53153,114097,99322,3837,100131,80158,101932,99883,3837,104088,35987,99210,99257,99488,102324,9370,76095,99461,102094,1773,101886,3837,35987,36993,101266,101185,85361,28404,100510,101309,99661,100679,101091,89977,31838,106962,102041,3837,99601,80158,104024,104117,104750,102166,103949,3837,100667,29490,5373,110304,29490,80565,100342,101121,104197,100176,9370,100125,99358,99463,111809,91956,63703,17340,99663,97907,101060,101079,3837,99360,35987,99210,104360,99164,99887,33108,117891,9370,108260,114278,104407,104437,99403,105442,1773,113423,101884,110996,101256,5373,111114,100367,33108,40820,100957,7948,109079,3837,101884,100174,5373,100159,5373,103140,33108,107527,9370,104437,3837,105749,101055,9370,42192,51232,110283,95411,74413,3837,100629,29258,99750,100240,1773,97639,99210,31838,101080,104267,109174,59743,88802,3837,112009,100022,104272,33108,99532,113709,3837,99661,34187,99532,107030,101996,1773,97639,105095,101884,16628,109174,59743,88802,3837,105095,100710,104407,104437,99403,90395,18493,99426,104015,104174,101334,104656,29490,104009,99532,99424,3837,101046,103140,3837,100346,117891,105200,104329,104197,29826,3837,100002,107162,104939,33108,101300,100701,103943,101918,29258,99750,100240,1773,101884,100802,104437,3837,101882,110110,29490,100627,109650,3837,104311,102309,101882,42140,99522,29490,101933,40916,109650,99185,16530,104117,9370,99426,100145,33108,17447,99371,99893,3837,101933,101109,16530,104117,9370,39352,75768,5373,99600,75768,33108,100383,75768,3837,105025,99639,82224,100789,5373,110312,104073,1773,97639,100156,99601,97706,109377,99226,102800,101271,57452,33108,104720,101055,104407,104437,99403,9370,94443,104073,102388,33108,101665,101218,102388,3837,97639,99351,53153,105270,40916,104056,110283,102784,3837,99351,53153,113277,42192,51232,110283,95411,74413,1773,100131,106682,107033,101309,103055,3837,105483,9370,99508,99208,109140,106158,101060,110283,102784,99461,99797,80565,3837,100002,104407,99328,9370,110283,102784,3837,99730,101892,100470,102665,33108,88991,54542,116861,99604,105155,9370,104409,9370,106025,85336,100638,3837,101892,109210,33108,100376,106320,74220,85336,100638,3837,99351,110263,118943,116861,99604,105155,104409,9370,114345,3837,99351,110263,105252,104407,104437,99403,113522,113707,104893,106492,101689,1773,35987,36993,101882,35987,99210,5373,35987,99292,33108,100342,99200,70769,99532,111032,40916,99462,3837,100642,99185,113707,104893,106492,101689,90395,100136,104078,106540,99793,3837,101182,99336,99251,101270,3837,99430,99560,99430,47534,3837,17714,18493,21894,101186,31843,99360,101055,99403,99787,104407,9370,104437,108388,68536,71817,100676,111159,66898,77,1699,256,42344,40820,7552,59,77,1699,262,220,100012,106748,104407,104437,99403,111784,88802,3837,99903,106113,34187,110555,99919,99346,99403,106187,107472,1773,99903,100140,3837,107033,101309,14777,99609,75108,110472,102050,101055,99346,99403,100034,9370,26940,67831,104983,100145,25067,100370,15946,101080,105166,106025,3837,107571,99346,104466,9370,105310,101279,3837,100000,99328,101091,113707,101945,101907,3837,104187,112517,100799,101086,100240,1773,100419,104022,3837,100662,103099,99328,101091,113707,3837,101892,105310,99346,104466,102715,3837,103952,110996,80158,100806,26381,29490,5373,100407,29490,106315,99185,3837,115666,3837,110996,80158,99185,107335,100636,118083,99805,55806,1773,99601,3837,97639,104415,113707,104893,106492,101689,3837,102005,33108,100356,34187,45861,100728,22243,53930,104775,101298,99346,100138,3837,99518,100345,100676,100022,76095,33108,118577,3837,103975,102322,100676,29258,99750,99346,101082,3837,32664,99346,117547,33108,108408,39907,108538,28951,100672,99895,96050,35926,47534,33126,21287,104558,99666,99185,40916,114774,105987,118683,9370,99346,99721,3837,101066,101910,99489,100455,107772,100455,101044,90395,100828,101046,101884,104437,31838,110706,9370,99891,33108,99460,99257,1773,101886,3837,101055,99346,99403,108485,70361,100806,26381,29490,5373,100407,29490,106315,99185,3837,100346,113306,64559,9370,66898,77,1699,262,34369,101,36993,104075,33108,100808,101185,14777,99609,99612,99609,5373,14777,99609,99568,136277,100845,9370,110996,101039,103956,3837,101898,104439,18493,25177,33447,71971,105659,101984,9370,117891,109597,106309,99903,104075,67338,1773,99903,100140,3837,99487,101039,103956,20412,99666,9370,111696,9370,1773,99903,103988,3837,114013,2073,63703,17340,99663,854,103934,3837,101055,110996,102005,33108,104174,64682,44729,102154,3837,14777,99609,110959,104300,48692,100174,117992,33108,102120,100666,101103,99260,110110,108397,1773,100131,100645,101038,3837,101887,99463,111809,91956,63703,17340,99663,97907,101930,104720,3837,110996,15946,97706,47606,100411,86119,1773,101883,29258,99750,102136,117400,104215,80443,100372,101933,101180,3837,99426,5373,99403,5373,105192,5373,104675,15946,104901,107977,102060,80443,100372,105109,3837,102507,99532,102438,100097,102467,100194,99774,100187,86119,100645,111400,100638,1773,114120,102332,100295,15946,101131,29490,104137,29490,100638,108990,3837,104414,100724,99799,102243,3837,105920,17714,104015,99185,113893,113433,105549,1773,99797,99403,100645,99666,29490,108204,32757,47534,29490,100516,32044,71817,3837,30534,101096,101102,75437,111594,100493,99191,3837,100186,14777,100151,68536,17447,3837,101090,105631,48692,33108,105214,66898,77,1699,44063,104135,104597,71817,102050,1773,151645,198,151644,77091,198};

const std::vector<int> warmup_ids2{151644,8948,198,2610,525,264,10950,17847,151645,198,151644,872,198,108386,103924,3837,105043,100165,11319,151645,198,151644,77091,198};

#endif //_GENERATE_H 
